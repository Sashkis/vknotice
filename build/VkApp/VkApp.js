var VkApp;!function(e){var t=function(){function e(e,t,s,r,o,i){this.$q=e,this.$http=t,this.storage=s,this.apiConfig=r,this.authConfig=o,this.stg={},this.authUrl="https://oauth.vk.com/authorize?"+i(o)}return e.prototype.isAuth=function(){var e=this,t=this.$q.defer();return this.stg.access_token&&this.stg.user_id?this.api("users.get",{access_token:this.stg.access_token}).then(function(s){t.resolve(s&&s[0]&&s[0].id&&s[0].id==e.stg.user_id)},function(){t.resolve(!1)}):t.resolve(!1),t.promise},e.prototype.parseHashParams=function(e){for(var t={},s=e.split("#")[1].split("&"),r=s.length;r--;)if(s[r]){var o=s[r].split("=");t[o[0]]=o[1]}return t},e.prototype.isAuthSuccess=function(e){return void 0===e&&(e={}),e&&e.user_id&&e.access_token&&e.state&&"vknotice"===e.state},e.prototype.auth=function(){var e=this,t=this.$q.defer();return this.storage.ready.then(function(s){e.stg=s,e.isAuth().then(function(s){s?t.resolve():(e.storage.set({user_id:0,access_token:""}),chrome.tabs.create({url:e.authUrl,active:!0},function(s){var r=s.id,o=function(t,s){if(r&&r===t&&s.url&&s.url.indexOf("oauth.vk.com/blank.html")>-1){var i=e.parseHashParams(s.url);if(!e.isAuthSuccess(i))return;e.storage.set({user_id:+i.user_id,access_token:i.access_token}),!!r&&chrome.tabs.remove(r),chrome.tabs.onUpdated.removeListener(o)}},i=function(s){r===s&&e.isAuth().then(function(e){t[e?"resolve":"reject"](),chrome.tabs.onRemoved.removeListener(i)})};chrome.tabs.onUpdated.addListener(o),chrome.tabs.onRemoved.addListener(i)}))})}),t.promise},e.prototype.api=function(e,t){var s=this;void 0===t&&(t={});var r=this.$q.defer();return t.v=this.apiConfig.version,this.$http.get("https://api.vk.com/method/"+e,{params:t}).then(function(o){s.isResponseSuccess(o.data)?r.resolve(o.data.response):o.data.error&&6===o.data.error.error_code?(console.warn("Wait to restart"),setTimeout(function(){console.warn("Restart"),s.api(e,t).then(r.resolve,r.reject)},2e3)):(console.error(o.data.error),r.reject("api_error"))},function(){r.reject("connect_error")}),r.promise},e.prototype.isResponseSuccess=function(e){return angular.isDefined(e.response)},e.$inject=["$q","$http","storage","apiConfig","authConfig","$httpParamSerializer"],e}();e.VkService=t}(VkApp||(VkApp={}));var VkApp;!function(e){const t="5.52";angular.module("VkApp",["StorageApp"]).constant("apiConfig",{version:t}).constant("authConfig",{redirect_uri:"https://oauth.vk.com/blank.html",client_id:4682781,scope:"offline,friends,messages,notifications,wall",response_type:"token",display:"popup",v:t,state:"vknotice"}).service("$vk",e.VkService)}(VkApp||(VkApp={}));