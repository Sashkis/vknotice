var BgApp;!function(t){var e=function(){function t(t,e,s,o,n){var i=this;this.storage=t,this.$vk=e,this.deamon=s,this.Config=o,this.Analytics=n,this.stg={},this.badge=0,t.ready.then(function(t){i.StgReady(t)}),t.onChanged(function(t){i.StgChanged(t)})}return t.prototype.StgReady=function(t){var e=this;return this.stg=t,this.cacheProfiles(t.users,t.groups),t.profiles&&t.profiles.length&&this.storage.clearProfiles(this.Config.profilesLimit),t.counter&&this.setBadge(),this.$vk.auth().then(function(){e.deamon.setConfig({method:"execute.ang",params:function(){return e.getDeamonParams()},DoneCB:function(t){return e.deamonDoneCB(t)},FailCB:function(t){return e.deamonFailCB(t)}}).start()}),this},t.prototype.cacheProfiles=function(){for(var t=this,e=[],s=0;s<arguments.length;s++)e[s-0]=arguments[s];return e.forEach(function(e){return e&&e.length&&t.storage.setProfiles(e)}),this},t.prototype.setBadge=function(){var t=0;return angular.isArray(this.stg.counter)||(angular.forEach(this.stg.counter,function(e){t+=angular.isNumber(e)?e:0}),this.playSound(t)),this.badge=t,chrome.browserAction.setBadgeText({text:t>0?""+t:""}),this},t.prototype.playSound=function(t){if(this.stg.options.audio===StorageApp.AudioOptionStatus.Never||t<=this.badge)return this;var e=document.getElementById("audio");return this.stg.options.audio===StorageApp.AudioOptionStatus.Always?(e.play(),this):(chrome.tabs.query({url:"*://*.vk.com/*"},function(t){t.length||e.play()}),this)},t.prototype.getDeamonParams=function(){var t={access_token:this.stg.access_token,options:"",notifyFilters:"",notifyLast_viewed:this.stg.notifyLast_viewed};return this.stg.options.friends&&(t.options+="friends,"),this.stg.options.photos&&(t.options+="photos,"),this.stg.options.videos&&(t.options+="videos,"),this.stg.options.messages&&(t.options+="messages,"),this.stg.options.groups&&(t.options+="groups,"),this.stg.options.wall&&(t.notifyFilters+="wall,"),this.stg.options.mentions&&(t.notifyFilters+="mentions,"),this.stg.options.comments&&(t.notifyFilters+="comments,"),this.stg.options.likes&&(t.notifyFilters+="likes,"),this.stg.options.reposts&&(t.notifyFilters+="reposts,"),this.stg.options.followers&&(t.notifyFilters+="followers,"),t},t.prototype.deamonDoneCB=function(t){return void 0===t&&(t={}),chrome.browserAction.setIcon({path:"img/icon38.png"}),t.dialogs&&t.dialogs.map(function(t){return t.message.attachments&&t.message.attachments.map(function(t){return t.type}),t}),delete t.system,this.storage.set(t),!0},t.prototype.deamonFailCB=function(t){return console.error(t),chrome.browserAction.setIcon({path:"img/icon38-off.png"}),"connect_error"===t},t.prototype.StgChanged=function(t){t.users&&(this.cacheProfiles(t.users.newValue),delete t.users),t.groups&&(this.cacheProfiles(t.groups.newValue),delete t.groups),t.counter&&t.counter.newValue&&(this.stg.counter=angular.copy(t.counter.newValue),this.setBadge(),delete t.counter),t.access_token&&(this.stg.access_token=t.access_token.newValue,delete t.access_token),t.user_id&&t.user_id.newValue&&(this.Analytics.set("&uid",t.user_id.newValue),this.stg.user_id=t.user_id.newValue,delete t.user_id);var e={};return angular.forEach(t,function(t,s){e[s]=angular.copy(t.newValue)}),this.storage.set(e,!1),this},t.$inject=["storage","$vk","deamon","Config","Analytics"],t}();t.BgClass=e}(BgApp||(BgApp={}));var BgApp;!function(t){angular.module("BgApp",["DeamonApp","angular-google-analytics"]).constant("Config",{profilesLimit:100}).config(["AnalyticsProvider",Helpers.setAnaliticSetting]).run(["Analytics","storage",Helpers.trackPage]).controller("Bg",t.BgClass)}(BgApp||(BgApp={}));