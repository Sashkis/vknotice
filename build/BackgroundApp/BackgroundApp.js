var SectionsApp;!function(t){!function(t){t[t.User=0]="User",t[t.Chat=1]="Chat",t[t.Group=2]="Group"}(t.DialogType||(t.DialogType={}));var e=t.DialogType,s=function(){function t(t){this.unread=0,this.profiles=[],this.in_read=t.in_read,this.out_read=t.out_read,this.unread=t.unread||0,t.message.chat_id?(this.title=t.message.title||"",this.type=e.Chat,this.peer_id=2e9+t.message.chat_id,this.photo_50=t.message.photo_50,t.message.chat_active&&angular.isArray(t.message.chat_active)&&(this.profiles=t.message.chat_active.slice(0,4))):(this.peer_id=t.message.user_id,this.type=this.peer_id>0?e.User:e.Group,this.profiles=[t.message.user_id]),this.url="https://vk.com/im?sel="+this.peer_id}return t}();t.Dialog=s}(SectionsApp||(SectionsApp={}));var BgApp;!function(t){var e=function(){function t(t,e,s,i,o,n){var r=this;this.storage=t,this.$vk=e,this.deamon=s,this.Config=i,this.Analytics=o,this.gettextCatalog=n,this.stg={},this.badge=0,t.ready.then(function(t){return r.StgReady(t)}),t.onChanged(function(t){return r.StgChanged(t)}),chrome.runtime.onInstalled.addListener(function(t){return r.onInstalled(t)}),chrome.alarms.onAlarm.addListener(function(t){return r.onAlarm(t)})}return t.prototype.StgReady=function(t){var e=this;return this.stg=t,t.groups&&(t.groups=t.groups.map(this.setNegativeID)),this.cacheProfiles(t.users,t.groups),t.profiles&&t.profiles.length&&this.storage.clearProfiles(this.Config.profilesLimit),t.counter&&this.setBadge(),this.$vk.auth().then(function(){e.deamon.setConfig({method:"execute.get",params:function(){return e.getDeamonParams()},DoneCB:function(t){return e.deamonDoneCB(t)},FailCB:function(t){return e.deamonFailCB(t)}}).start()}),this},t.prototype.cacheProfiles=function(){for(var t=this,e=[],s=0;s<arguments.length;s++)e[s-0]=arguments[s];return e.forEach(function(e){return e&&e.length&&t.storage.setProfiles(e)}),this},t.prototype.setNegativeID=function(t){return t.id=-t.id,t},t.prototype.setBadge=function(){var t=0;return angular.isArray(this.stg.counter)||(angular.forEach(this.stg.counter,function(e){t+=angular.isNumber(e)?e:0}),this.playSound(t)),this.badge=t,chrome.browserAction.setBadgeText({text:t>0?""+t:""}),this},t.prototype.playSound=function(t){if(this.stg.options.audio===StorageApp.AudioOptionStatus.Never||t<=this.badge)return this;var e=document.getElementById("audio");return this.stg.options.audio===StorageApp.AudioOptionStatus.Always?(e.play(),this):(chrome.tabs.query({url:"*://*.vk.com/*"},function(t){t.length||e.play()}),this)},t.prototype.getDeamonParams=function(){var t={access_token:this.stg.access_token,options:"",notifyFilters:"",notifyLast_viewed:this.stg.notifyLast_viewed,func_v:2};return this.stg.options.friends&&(t.options+="friends,"),this.stg.options.photos&&(t.options+="photos,"),this.stg.options.videos&&(t.options+="videos,"),this.stg.options.messages&&(t.options+="messages,"),this.stg.options.groups&&(t.options+="groups,"),this.stg.options.wall&&(t.notifyFilters+="wall,"),this.stg.options.mentions&&(t.notifyFilters+="mentions,"),this.stg.options.comments&&(t.notifyFilters+="comments,"),this.stg.options.likes&&(t.notifyFilters+="likes,"),this.stg.options.reposts&&(t.notifyFilters+="reposts,"),this.stg.options.followers&&(t.notifyFilters+="followers,"),t},t.prototype.deamonDoneCB=function(t){return void 0===t&&(t={}),chrome.browserAction.setIcon({path:"img/icon38.png"}),angular.isArray(t.dialogs)&&(t.dialogs=t.dialogs.map(function(t){return new SectionsApp.Dialog(t)})),delete t.system,this.storage.set(t),!0},t.prototype.deamonFailCB=function(t){return console.error(t),chrome.browserAction.setIcon({path:"img/icon38-off.png"}),"connect_error"===t},t.prototype.StgChanged=function(t){t.users&&(this.cacheProfiles(t.users.newValue),delete t.users),t.groups&&(angular.isArray(t.groups.newValue)&&(t.groups.newValue=t.groups.newValue.map(this.setNegativeID)),this.cacheProfiles(t.groups.newValue),delete t.groups),t.counter&&t.counter.newValue&&(this.stg.counter=angular.copy(t.counter.newValue),this.setBadge(),delete t.counter),t.access_token&&(this.stg.access_token=t.access_token.newValue,delete t.access_token),t.user_id&&t.user_id.newValue&&(this.Analytics.set("&uid",t.user_id.newValue),this.stg.user_id=t.user_id.newValue,delete t.user_id);var e={};return angular.forEach(t,function(t,s){return e[s]=angular.copy(t.newValue)}),this.storage.set(e,!1),this},t.prototype.pushAlert=function(t){this.stg.alerts.push(t),this.storage.set({alerts:this.stg.alerts})},t.prototype.onInstalled=function(t){"install"===t.reason&&(chrome.alarms.create("get_review",{delayInMinutes:7200}),chrome.alarms.create("say_thanks",{delayInMinutes:14400}))},t.prototype.onAlarm=function(t){var e;switch(t.name){case"get_review":e={id:"get_review",type:"simple",img:"https://vk.com/images/stickers/644/128.png",text:this.gettextCatalog.getString("Помогите нам стать лучше"),ancor:this.gettextCatalog.getString("Оставьте свой отзыв"),url:Helpers.getReviewUrl()};break;case"say_thanks":e={id:"say_thanks",type:"simple",img:"https://vk.com/images/stickers/630/128.png",text:this.gettextCatalog.getString("Мы старались для вас"),ancor:this.gettextCatalog.getString("Скажите авторам «Спасибо»"),url:Helpers.getShareUrl()}}e&&this.pushAlert(e)},t.$inject=["storage","$vk","deamon","Config","Analytics","gettextCatalog"],t}();t.BgClass=e}(BgApp||(BgApp={}));var BgApp;!function(t){angular.module("BgApp",["DeamonApp","angular-google-analytics","gettext"]).constant("Config",{profilesLimit:100}).config(["AnalyticsProvider",Helpers.setAnaliticSetting]).run(["Analytics","storage",Helpers.trackPage]).controller("Bg",t.BgClass)}(BgApp||(BgApp={}));