var SectionsApp;!function(e){function t(e){function t(t){return"object"==typeof t?t:e.getProfile(t)}return{templateUrl:"/SectionApp/sections/NewMess/dialog.tpl",replace:!0,link:function(e){e.dialog.profiles=e.dialog.profiles.map(t)}}}e.DialogDirective=t,t.$inject=["storage"]}(SectionsApp||(SectionsApp={}));var SectionsApp;!function(e){var t=function(){function e(){this.emojiCharSeq=/[0-9\uD83D\uD83C]/,this.emojiRegEx=/((?:[\uE000-\uF8FF\u270A-\u2764\u2122\u231B\u25C0\u25FB-\u25FE\u2615\u263a\u2648-\u2653\u2660-\u2668\u267B\u267F\u2693\u261d\u26A0-\u26FA\u2708\u2702\u2601\u260E]|[\u2600\u26C4\u26BE\u23F3\u2705\u2764]|[\uD83D\uD83C][\uDC00-\uDFFF]|\uD83C[\uDDE6-\uDDFF]\uD83C[\uDDE6-\uDDFF]|[0-9]\u20e3|[\u200C\u200D])+)/g,this.pathToEmojisImages="https://vk.com/images/emoji/"}return e.prototype.getEmojiHTML=function(e,t){return console.log(e),'<img class="emoji" '+(t?'alt="'+t+'"':"")+' src="'+this.pathToEmojisImages+e+'.png" />'},e.prototype.emojiToHTML=function(e){var t=this,s={D83DDE07:/(\s|^)([0OО]:\))([\s\.,]|$)/g,D83DDE09:/(\s|^)(;-\)+)([\s\.,]|$)/g,D83DDE06:/(\s|^)([XХxх]-?D)([\s\.,]|$)/g,D83DDE0E:/(\s|^)(B-\))([\s\.,]|$)/g,D83DDE0C:/(\s|^)(3-\))([\s\.,]|$)/g,D83DDE20:/(\s|^)(&gt;\()([\s\.,]|$)/g,D83DDE30:/(\s|^)(;[oоOО])([\s\.,]|$)/g,D83DDE33:/(\s|^)(8\|)([\s\.,]|$)/g,D83DDE32:/(\s|^)(8-?[oоOО])([\s\.,]|$)/g,D83DDE0D:/(\s|^)(8-\))([\s\.,]|$)/g,D83DDE37:/(\s|^)(:[XХ])([\s\.,]|$)/g,D83DDE28:/(\s|^)(:[oоOО])([\s\.,]|$)/g,2764:/(\s|^)(&lt;3)([\s\.,]|$)/g,D83DDE0A:/(:-\))([\s\.,]|$)/g,D83DDE03:/(:-D)([\s\.,]|$)/g,D83DDE1C:/(;-[PР])([\s\.,]|$)/g,D83DDE0B:/(:-[pр])([\s\.,]|$)/g,D83DDE12:/(:-\()([\s\.,]|$)/g,"263A":/(:-?\])([\s\.,]|$)/g,D83DDE0F:/(;-\])([\s\.,]|$)/g,D83DDE14:/(3-?\()([\s\.,]|$)/g,D83DDE22:/(:&#039;\()([\s\.,]|$)/g,D83DDE2D:/(:_\()([\s\.,]|$)/g,D83DDE29:/(:\(\()([\s\.,]|$)/g,D83DDE10:/(:\|)([\s\.,]|$)/g,D83DDE21:/(&gt;\(\()([\s\.,]|$)/g,D83DDE1A:/(:-\*)([\s\.,]|$)/g,D83DDE08:/(\}:\))([\s\.,]|$)/g,D83DDC4D:/(:like:)([\s\.,]|$)/g,D83DDC4E:/(:dislike:)([\s\.,]|$)/g,"261D":/(:up:)([\s\.,]|$)/g,"270C":/(:v:)([\s\.,]|$)/g,D83DDC4C:/(:ok:|:ок:)([\s\.,]|$)/g};for(var n in s)e.indexOf(n)>-1&&(e=e.replace(s[n],this.getEmojiHTML(n)));return e.replace(this.emojiRegEx,function(e){return t.emojiReplace(e)}).replace(/\uFE0F/g,"")},e.prototype.emojiReplace=function(e){for(var t="",s="",n=!1,i=!1,o="",r=[],a=[],u=0;u<e.length;u++){var c=e.charCodeAt(u),p=c.toString(16).toUpperCase(),l=e.charAt(u);1!==u||8419!==c?(t+=p,s+=l,l.match(this.emojiCharSeq)||(a.push(t),r.push(s),t="",s="")):(a.push("003"+e.charAt(0)+"20E3"),r.push(e.charAt(0)),t="",s="")}t&&(a.push(t),r.push(s)),t="",s="";for(var u=0;u<a.length;u++){var p=a[u],l=r[u];if(l.match(/\uD83C[\uDFFB-\uDFFF]/))t+=p,s+=l;else if(n)t+=p,s+=l,n=!1;else{if("200C"===p||"200D"===p){if(t){n=!0;continue}o+=l}if(l.match(/\uD83C[\uDDE6-\uDDFF]/)){if(i){t+=p,s+=l,i=!1;continue}i=!0}else i&&(i=!1);t&&(o+=this.getEmojiHTML(t,s)),t=p,s=l}}return t&&(o+=this.getEmojiHTML(t,s)),o},e}();e.Emoji=t}(SectionsApp||(SectionsApp={}));var SectionsApp;!function(e){var t=function(){function t(t){angular.extend(this,t);var s=angular.injector(["ng","ngSanitize"]);s.get("$filter");this.emoji&&(this.body=(new e.Emoji).emojiToHTML(this.body))}return t}();e.Message=t}(SectionsApp||(SectionsApp={}));var SectionsApp;!function(e){var t=function(){function t(t,s,n,i,o){var r=this;this.storage=t,this.$routeParams=s,this.$vk=n,this.$scope=i,this.deamon=o,t.ready.then(function(s){if(r.stg=s,r.currentDialog=r.getCurrentDialog(),r.currentDialog){var a=r.currentDialog.peer_id;n.auth().then(function(){n.api("execute.getHistory",{access_token:n.stg.access_token,peer_id:a,count:100}).then(function(s){t.setProfiles(s.profiles),r.currentDialog&&r.currentDialog.peer_id===a&&(r.currentDialog.unread=s.history.unread||0,r.currentDialog.message=s.history.items.map(function(t){return new e.Message(t)})),r.LongPollParams={access_token:n.stg.access_token,ts:s.server.ts,pts:s.server.pts,fields:"screen_name,status,photo_50,online"},o.setConfig({method:"messages.getLongPollHistory",params:r.LongPollParams,interval:1e3,DoneCB:function(e){return r.onLongPollDone(e)}}).start(),i.$on("$destroy",function(){o.stop()})})})}})}return t.prototype.onLongPollDone=function(t){var s=this;if(this.LongPollParams.pts=t.new_pts,angular.isArray(t.profiles)&&this.storage.setProfiles(t.profiles),!this.currentDialog)return!0;var n=this.currentDialog.peer_id;return angular.forEach(t.history,function(i){switch(i[0]){case 4:var o=(i[0],i[1]),r=(i[2],i[3]);if(r!==n||!s.currentDialog)return;var a=new e.Message(t.messages.items.find(function(e){return e.id===o}));s.currentDialog.message||(s.currentDialog.message=[]),s.currentDialog.message.unshift(a);break;default:console.log(i)}}),!0},t.prototype.getCurrentDialog=function(){if(this.stg&&this.stg.dialogs.length&&this.$routeParams.peer_id){var e=+this.$routeParams.peer_id;return this.stg.dialogs.find(function(t){return e===t.peer_id})}},t.prototype.markAsRead=function(e){var t=this;this.$vk.auth().then(function(){t.$vk.api("messages.markAsRead",{access_token:t.$vk.stg.access_token,peer_id:e})})},t.prototype.sendMessage=function(){var e=this;if(this.currentDialog){var t=this.currentDialog.peer_id,s=this.message;this.$vk.auth().then(function(){e.$vk.api("messages.send",{access_token:e.$vk.stg.access_token,message:s,peer_id:t}).then(function(t){e.message=""})})}},t.$inject=["storage","$routeParams","$vk","$scope","deamon"],t}();e.NewMessCtrl=t}(SectionsApp||(SectionsApp={}));var SectionsApp;!function(e){var t=function(){function e(e,t,s,n,i){var o=this;this.storage=e,this.Analytics=t,this.$location=s,this.$window=n,e.ready.then(function(e){t.set("&uid",e.user_id),"/"!==e.currentSection&&s.url(e.currentSection)}),i.$on("$locationChangeStart",function(){return o.saveSection()})}return e.prototype.isNoRoot=function(){return"/"!==this.$location.url()},e.prototype.saveSection=function(){this.storage.set({currentSection:this.$location.url()})},e.$inject=["storage","Analytics","$location","$window","$scope"],e}();e.SectionsCtrl=t}(SectionsApp||(SectionsApp={}));var SectionsApp;!function(e){angular.module("SectionsApp",["VkApp","StorageApp","ngRoute","ngSanitize","DeamonApp"]).config(["$routeProvider","AnalyticsProvider",function(e,t){t.readFromRoute(!0).trackPrefix("/Popup"),e.when("/",{templateUrl:"/SectionApp/sections/Default/Default.tpl",name:"Меню"}).when("/NewFriends",{templateUrl:"/SectionApp/sections/NewFriends/NewFriends.tpl"}).when("/NewMess",{templateUrl:"/SectionApp/sections/NewMess/NewMess.tpl"}).when("/NewMess/:peer_id",{templateUrl:"/SectionApp/sections/NewMess/NewMess.tpl"}).otherwise({redirectTo:"/"})}]).controller("SectionsCtrl",e.SectionsCtrl).controller("NewMessCtrl",e.NewMessCtrl).directive("vkDialog",e.DialogDirective)}(SectionsApp||(SectionsApp={})),angular.module("SectionsApp").controller("SidebarCtrl",["storage",function(e){var t=this;e.ready.then(function(e){t.stg=e})}]),angular.module("SectionsApp").controller("FriendsCtrl",["storage",function(e){var t=this;e.ready.then(function(e){t.stg=e})}]).directive("friend",["storage",function(e){return{restrict:"E",replace:"true",templateUrl:"../SectionApp/sections/Default/friend.tpl",scope:{id:"="},link:function(t){t.user=e.getProfile(t.id)}}}]),angular.module("SectionsApp").controller("NewFriendsCtrl",["storage","$vk",function(e,t){var s=this;s.mark=function(e,s,n){e.preventDefault();var i=!1;switch(s){case"add":i="friends.add";break;case"ban":i="account.banUser";break;case"delete":i="friends.delete";break;case"deleteAll":i="friends.deleteAllRequests"}i&&t.auth().then(function(){t.api(i,{user_id:n,access_token:t.stg.access_token}).then(function(){})})},e.ready.then(function(e){s.stg=e})}]).directive("request",["storage",function(e){return{restrict:"E",replace:"true",templateUrl:"../SectionApp/sections/NewFriends/request.tpl",scope:!0,link:function(t,s,n){t.user=e.getProfile(+n.userId)}}}]);