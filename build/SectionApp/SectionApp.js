var SectionsApp;!function(e){function t(e){function t(t){return"object"==typeof t?t:e.getProfile(t)}return{templateUrl:"/SectionApp/sections/NewMess/dialog.tpl",replace:!0,link:function(e){e.dialog.profiles=e.dialog.profiles.map(t)}}}e.DialogDirective=t,t.$inject=["storage"]}(SectionsApp||(SectionsApp={}));var SectionsApp;!function(e){var t=function(){function e(){this.emojiCharSeq=/[0-9\uD83D\uD83C]/,this.emojiRegEx=/((?:[\uE000-\uF8FF\u270A-\u2764\u2122\u231B\u25C0\u25FB-\u25FE\u2615\u263a\u2648-\u2653\u2660-\u2668\u267B\u267F\u2693\u261d\u26A0-\u26FA\u2708\u2702\u2601\u260E]|[\u2600\u26C4\u26BE\u23F3\u2705\u2764]|[\uD83D\uD83C][\uDC00-\uDFFF]|\uD83C[\uDDE6-\uDDFF]\uD83C[\uDDE6-\uDDFF]|[0-9]\u20e3|[\u200C\u200D])+)/g,this.pathToEmojisImages="https://vk.com/images/emoji/"}return e.prototype.getEmojiHTML=function(e,t){return'<img class="emoji" '+(t?'alt="'+t+'"':"")+' src="'+this.pathToEmojisImages+e+'.png" />'},e.prototype.emojiToHTML=function(e){var t=this,s={D83DDE07:/(\s|^)([0OО]:\))([\s\.,]|$)/g,D83DDE09:/(\s|^)(;-\)+)([\s\.,]|$)/g,D83DDE06:/(\s|^)([XХxх]-?D)([\s\.,]|$)/g,D83DDE0E:/(\s|^)(B-\))([\s\.,]|$)/g,D83DDE0C:/(\s|^)(3-\))([\s\.,]|$)/g,D83DDE20:/(\s|^)(&gt;\()([\s\.,]|$)/g,D83DDE30:/(\s|^)(;[oоOО])([\s\.,]|$)/g,D83DDE33:/(\s|^)(8\|)([\s\.,]|$)/g,D83DDE32:/(\s|^)(8-?[oоOО])([\s\.,]|$)/g,D83DDE0D:/(\s|^)(8-\))([\s\.,]|$)/g,D83DDE37:/(\s|^)(:[XХ])([\s\.,]|$)/g,D83DDE28:/(\s|^)(:[oоOО])([\s\.,]|$)/g,2764:/(\s|^)(&lt;3)([\s\.,]|$)/g,D83DDE0A:/(:-\))([\s\.,]|$)/g,D83DDE03:/(:-D)([\s\.,]|$)/g,D83DDE1C:/(;-[PР])([\s\.,]|$)/g,D83DDE0B:/(:-[pр])([\s\.,]|$)/g,D83DDE12:/(:-\()([\s\.,]|$)/g,"263A":/(:-?\])([\s\.,]|$)/g,D83DDE0F:/(;-\])([\s\.,]|$)/g,D83DDE14:/(3-?\()([\s\.,]|$)/g,D83DDE22:/(:&#039;\()([\s\.,]|$)/g,D83DDE2D:/(:_\()([\s\.,]|$)/g,D83DDE29:/(:\(\()([\s\.,]|$)/g,D83DDE10:/(:\|)([\s\.,]|$)/g,D83DDE21:/(&gt;\(\()([\s\.,]|$)/g,D83DDE1A:/(:-\*)([\s\.,]|$)/g,D83DDE08:/(\}:\))([\s\.,]|$)/g,D83DDC4D:/(:like:)([\s\.,]|$)/g,D83DDC4E:/(:dislike:)([\s\.,]|$)/g,"261D":/(:up:)([\s\.,]|$)/g,"270C":/(:v:)([\s\.,]|$)/g,D83DDC4C:/(:ok:|:ок:)([\s\.,]|$)/g};for(var i in s)e.indexOf(i)>-1&&(e=e.replace(s[i],this.getEmojiHTML(i)));return e.replace(this.emojiRegEx,function(e){return t.emojiReplace(e)}).replace(/\uFE0F/g,"")},e.prototype.emojiReplace=function(e){for(var t="",s="",i=!1,n=!1,r="",o=[],a=[],c=0;c<e.length;c++){var u=e.charCodeAt(c),p=u.toString(16).toUpperCase(),l=e.charAt(c);1!==c||8419!==u?(t+=p,s+=l,l.match(this.emojiCharSeq)||(a.push(t),o.push(s),t="",s="")):(a.push("003"+e.charAt(0)+"20E3"),o.push(e.charAt(0)),t="",s="")}t&&(a.push(t),o.push(s)),t="",s="";for(var c=0;c<a.length;c++){var p=a[c],l=o[c];if(l.match(/\uD83C[\uDFFB-\uDFFF]/))t+=p,s+=l;else if(i)t+=p,s+=l,i=!1;else{if("200C"===p||"200D"===p){if(t){i=!0;continue}r+=l}if(l.match(/\uD83C[\uDDE6-\uDDFF]/)){if(n){t+=p,s+=l,n=!1;continue}n=!0}else n&&(n=!1);t&&(r+=this.getEmojiHTML(t,s)),t=p,s=l}}return t&&(r+=this.getEmojiHTML(t,s)),r},e}();e.Emoji=t}(SectionsApp||(SectionsApp={}));var SectionsApp;!function(e){function t(){return{templateUrl:"/SectionApp/sections/NewMess/attachment.tpl",replace:!0}}e.AttachmentDirective=t}(SectionsApp||(SectionsApp={}));var SectionsApp;!function(e){function t(){return{templateUrl:"/SectionApp/sections/NewMess/message.tpl",replace:!1}}e.MessageDirective=t}(SectionsApp||(SectionsApp={}));var SectionsApp;!function(e){var t=function(){function e(e){angular.extend(this,e),angular.isArray(this.fwd_messages)&&(this.attachments||(this.attachments=[]),console.log(this),this.attachments.push({type:"fwd_messages",fwd_messages:{items:this.fwd_messages}}),delete this.fwd_messages)}return e}();e.Message=t}(SectionsApp||(SectionsApp={}));var SectionsApp;!function(e){var t=function(){function t(t,s,i,n,r){var o=this;this.storage=t,this.$routeParams=s,this.$vk=i,this.$scope=n,this.deamon=r,t.ready.then(function(s){if(o.stg=s,o.currentDialog=o.getCurrentDialog(),o.currentDialog){var a=o.currentDialog.peer_id;i.auth().then(function(){i.api("execute.getHistory",{access_token:i.stg.access_token,peer_id:a,count:100}).then(function(s){t.setProfiles(s.profiles),o.currentDialog&&o.currentDialog.peer_id===a&&(o.currentDialog.unread=s.history.unread||0,o.currentDialog.message=s.history.items.map(function(t){return new e.Message(t)})),o.LongPollParams={access_token:i.stg.access_token,ts:s.server.ts,pts:s.server.pts,fields:"screen_name,status,photo_50,online"},r.setConfig({method:"messages.getLongPollHistory",params:o.LongPollParams,interval:1e3,DoneCB:function(e){return o.onLongPollDone(e)}}).start(),n.$on("$destroy",function(){r.stop()})})})}})}return t.prototype.onLongPollDone=function(t){var s=this;if(this.LongPollParams.pts=t.new_pts,angular.isArray(t.profiles)&&this.storage.setProfiles(t.profiles),!this.currentDialog)return!0;var i=this.currentDialog.peer_id;return angular.forEach(t.history,function(n){switch(n[0]){case 4:var r=(n[0],n[1]),o=(n[2],n[3]);if(o!==i||!s.currentDialog)return;var a=new e.Message(t.messages.items.find(function(e){return e.id===r}));s.currentDialog.message||(s.currentDialog.message=[]),s.currentDialog.message.unshift(a);break;default:console.log(n)}}),!0},t.prototype.getCurrentDialog=function(){if(this.stg&&this.stg.dialogs.length&&this.$routeParams.peer_id){var e=+this.$routeParams.peer_id;return this.stg.dialogs.find(function(t){return e===t.peer_id})}},t.prototype.markAsRead=function(e){var t=this;this.$vk.auth().then(function(){t.$vk.api("messages.markAsRead",{access_token:t.$vk.stg.access_token,peer_id:e})})},t.prototype.sendMessage=function(){var e=this;if(this.currentDialog){var t=this.currentDialog.peer_id,s=this.message;this.$vk.auth().then(function(){e.$vk.api("messages.send",{access_token:e.$vk.stg.access_token,message:s,peer_id:t}).then(function(t){e.message=""})})}},t.$inject=["storage","$routeParams","$vk","$scope","deamon"],t}();e.NewMessCtrl=t}(SectionsApp||(SectionsApp={}));var SectionsApp;!function(e){function t(e){function t(t){return"object"==typeof t?t:e.getProfile(t)}return{template:'<img class="ava" ng-src="{{src}}">',scope:{profileId:"=?",src:"=?"},link:function(e){if(!e.src&&e.profileId){var s=t(e.profileId);s.photo_50&&(e.src=s.photo_50)}}}}e.userAvaDirective=t,e.DialogDirective.$inject=["storage"]}(SectionsApp||(SectionsApp={}));var SectionsApp;!function(e){function t(e){function t(t){return"object"==typeof t?t:e.getProfile(t)}return{template:'{{profile.name || profile.first_name+" "+profile.last_name}}',scope:{profileId:"="},link:function(e){e.profile=t(e.profileId),console.log(e.profile)}}}e.userNameDirective=t,e.DialogDirective.$inject=["storage"]}(SectionsApp||(SectionsApp={}));var SectionsApp;!function(e){var t=function(){function e(e,t,s,i,n){var r=this;this.storage=e,this.Analytics=t,this.$location=s,this.$window=i,e.ready.then(function(e){t.set("&uid",e.user_id),"/"!==e.currentSection&&s.url(e.currentSection)}),n.$on("$locationChangeStart",function(){return r.saveSection()})}return e.prototype.isNoRoot=function(){return"/"!==this.$location.url()},e.prototype.saveSection=function(){this.storage.set({currentSection:this.$location.url()})},e.$inject=["storage","Analytics","$location","$window","$scope"],e}();e.SectionsCtrl=t}(SectionsApp||(SectionsApp={}));var SectionsApp;!function(e){angular.module("SectionsApp",["VkApp","StorageApp","ngRoute","DeamonApp"]).config(["$routeProvider","AnalyticsProvider",function(e,t){t.readFromRoute(!0).trackPrefix("/Popup"),e.when("/",{templateUrl:"/SectionApp/sections/Default/Default.tpl",name:"Меню"}).when("/NewFriends",{templateUrl:"/SectionApp/sections/NewFriends/NewFriends.tpl"}).when("/NewMess",{templateUrl:"/SectionApp/sections/NewMess/NewMess.tpl"}).when("/NewMess/:peer_id",{templateUrl:"/SectionApp/sections/NewMess/NewMess.tpl"}).otherwise({redirectTo:"/"})}]).controller("SectionsCtrl",e.SectionsCtrl).controller("NewMessCtrl",e.NewMessCtrl).directive("userAva",e.userAvaDirective).directive("userName",e.userNameDirective).directive("vkDialog",e.DialogDirective).directive("message",e.MessageDirective).directive("attachment",e.AttachmentDirective).filter("emoji",["$sce",function(t){return function(s){return t.trustAsHtml((new e.Emoji).emojiToHTML(s))}}]).filter("linkify",function(){return function(e){return linkifyStr(e,{format:function(e,t){return"url"===t&&e.length>40&&(e=e.slice(0,25)+"…"),e}})}})}(SectionsApp||(SectionsApp={})),angular.module("SectionsApp").controller("SidebarCtrl",["storage",function(e){var t=this;e.ready.then(function(e){t.stg=e})}]),angular.module("SectionsApp").controller("FriendsCtrl",["storage",function(e){var t=this;e.ready.then(function(e){t.stg=e})}]).directive("friend",["storage",function(e){return{restrict:"E",replace:"true",templateUrl:"../SectionApp/sections/Default/friend.tpl",scope:{id:"="},link:function(t){t.user=e.getProfile(t.id)}}}]),angular.module("SectionsApp").controller("NewFriendsCtrl",["storage","$vk",function(e,t){var s=this;s.mark=function(e,s,i){e.preventDefault();var n=!1;switch(s){case"add":n="friends.add";break;case"ban":n="account.banUser";break;case"delete":n="friends.delete";break;case"deleteAll":n="friends.deleteAllRequests"}n&&t.auth().then(function(){t.api(n,{user_id:i,access_token:t.stg.access_token}).then(function(){})})},e.ready.then(function(e){s.stg=e})}]).directive("request",["storage",function(e){return{restrict:"E",replace:"true",templateUrl:"../SectionApp/sections/NewFriends/request.tpl",scope:!0,link:function(t,s,i){t.user=e.getProfile(+i.userId)}}}]);